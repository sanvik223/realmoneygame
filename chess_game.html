<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>চেস গেম | Real Money Game</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: url('https://i.postimg.cc/9f3TghpB/Wallpaper-Kemra-Black-Wood-1-jpg-optimal.jpg') no-repeat center center fixed;
            background-size: cover;
            color: #fff;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }
        
        #game-container {
            width: 100%;
            max-width: 800px;
            height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 20px;
            background-color: rgba(0, 0, 0, 0.7);
        }
        
        #reward-display {
            background: linear-gradient(135deg, #4361ee, #3f37c9);
            padding: 10px;
            border-radius: 8px;
            font-weight: bold;
            font-size: 18px;
            text-align: center;
            margin-bottom: 20px;
            color: white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        #opponent-info {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            margin-bottom: 15px;
        }
        
        #player-info {
            display: flex;
            justify-content: flex-start;
            align-items: center;
            margin-top: 15px;
        }
        
        .profile {
            display: flex;
            align-items: center;
        }
        
        .profile-info {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            margin-right: 10px;
        }
        
        .player-profile-info {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            margin-left: 10px;
        }
        
        .profile-name {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 5px;
        }
        
        .profile-pic {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #4a2e8a, #6e48aa);
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        
        .profile-pic img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .timer {
            background: #333;
            padding: 8px 12px;
            border-radius: 20px;
            font-family: 'Courier New', monospace;
            font-size: 16px;
            font-weight: bold;
            margin-left: 10px;
            min-width: 80px;
            text-align: center;
            color: #ffd700;
        }
        
        #board-container {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        #board {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            grid-template-rows: repeat(8, 1fr);
            width: 90vw;
            height: 90vw;
            max-width: 500px;
            max-height: 500px;
            border: 10px solid #4361ee;
            border-radius: 5px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        
        .square {
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 40px;
            cursor: pointer;
            position: relative;
        }
        
        .light {
            background-color: #f0d9b5;
        }
        
        .dark {
            background-color: #b58863;
        }
        
        .selected {
            background-color: rgba(100, 255, 100, 0.7) !important;
        }
        
        .possible-move::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background-color: rgba(0, 0, 0, 0.3);
        }
        
        .possible-capture {
            position: relative;
        }
        
        .possible-capture::before {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 3px solid rgba(255, 0, 0, 0.7);
        }
        
        .white {
            color: white;
            text-shadow: 1px 1px 2px #000;
        }
        
        .black {
            color: black;
            text-shadow: 1px 1px 2px #fff;
        }
        
        #status {
            font-size: 18px;
            font-weight: bold;
            padding: 10px;
            text-align: center;
            margin: 10px 0;
            color: #ffd700;
        }
        
        #chat-button {
            position: fixed;
            right: 20px;
            bottom: 20px;
            background: linear-gradient(135deg, #4361ee, #3f37c9);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            z-index: 10;
        }
        
        #chat-container {
            display: none;
            position: fixed;
            right: 20px;
            bottom: 90px;
            width: 300px;
            height: 400px;
            background: #1a1a2e;
            border-radius: 10px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.4);
            z-index: 100;
            flex-direction: column;
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        #chat-header {
            background: linear-gradient(135deg, #4361ee, #3f37c9);
            padding: 15px;
            font-weight: bold;
            text-align: center;
            font-size: 18px;
            color: white;
        }
        
        #chat-messages {
            flex: 1;
            padding: 10px;
            overflow-y: auto;
            background: #0f0f1a;
        }
        
        .message {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 8px;
            word-wrap: break-word;
            max-width: 80%;
        }
        
        .own-message {
            background: linear-gradient(135deg, #4361ee, #3f37c9);
            margin-left: auto;
            text-align: right;
            color: white;
        }
        
        .opponent-message {
            background: #333;
            margin-right: auto;
        }
        
        #chat-input-container {
            display: flex;
            padding: 10px;
            background: #1a1a2e;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        
        #chat-message {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 5px 0 0 5px;
            background: #0f0f1a;
            color: #fff;
            font-size: 14px;
        }
        
        #chat-send {
            border-radius: 0 5px 5px 0;
            padding: 10px 15px;
            background: linear-gradient(135deg, #4361ee, #3f37c9);
            color: white;
            border: none;
            cursor: pointer;
        }
        
        .check {
            box-shadow: inset 0 0 20px rgba(255, 0, 0, 0.5);
        }
        
        .last-move {
            background-color: rgba(255, 255, 0, 0.3);
        }
        
        #promotion-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #1a1a2e;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.4);
            z-index: 100;
            border: 1px solid rgba(255,255,255,0.1);
            color: white;
        }
        
        #promotion-options {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
        }
        
        .promotion-option {
            font-size: 40px;
            cursor: pointer;
            padding: 10px;
            border-radius: 5px;
            background: rgba(255,255,255,0.1);
        }
        
        .promotion-option:hover {
            background: rgba(255,255,255,0.2);
        }
        
        #back-button {
            position: fixed;
            top: 15px;
            left: 15px;
            background: rgba(0, 0, 0, 0.5);
            border: none;
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        @media (max-width: 600px) {
            #board {
                width: 95vw;
                height: 95vw;
            }
            
            .square {
                font-size: 30px;
            }
            
            #chat-container {
                width: 250px;
                height: 350px;
                right: 10px;
                bottom: 80px;
            }
            
            .profile-pic {
                width: 40px;
                height: 40px;
                font-size: 16px;
            }
            
            .profile-name {
                font-size: 14px;
            }
            
            .timer {
                font-size: 14px;
                padding: 6px 10px;
                min-width: 70px;
            }
        }
    </style>
</head>
<body>
    <button id="back-button" onclick="exitGame()">
        <i class="fas fa-arrow-left"></i> বের হোন
    </button>
    
    <div id="game-container">
        <div id="game-area">
            <div id="reward-display">পুরস্কার: ৳<span id="reward-amount">0</span></div>
            
            <div id="opponent-info">
                <div class="profile">
                    <div class="profile-info">
                        <div class="profile-name" id="opponent-name">প্রতিপক্ষ</div>
                        <div class="timer" id="opponent-timer">30:00</div>
                    </div>
                    <div class="profile-pic" id="opponent-image">
                        <i class="fas fa-user"></i>
                    </div>
                </div>
            </div>
            
            <div id="board-container">
                <div id="board"></div>
            </div>
            
            <div id="player-info">
                <div class="profile">
                    <div class="profile-pic" id="player-image">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="player-profile-info">
                        <div class="profile-name" id="player-name">আপনি</div>
                        <div class="timer" id="player-timer">30:00</div>
                    </div>
                </div>
            </div>
            
            <div id="status">গেম প্রস্তুত</div>
            
            <button id="chat-button"><i class="fas fa-comment"></i></button>
            
            <div id="chat-container">
                <div id="chat-header">চ্যাট</div>
                <div id="chat-messages"></div>
                <div id="chat-input-container">
                    <input type="text" id="chat-message" placeholder="মেসেজ লিখুন...">
                    <button id="chat-send"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
            
            <div id="promotion-modal">
                <h3>সৈনিককে রূপান্তর করুন:</h3>
                <div id="promotion-options">
                    <div class="promotion-option white" data-piece="Q">♕</div>
                    <div class="promotion-option white" data-piece="R">♖</div>
                    <div class="promotion-option white" data-piece="B">♗</div>
                    <div class="promotion-option white" data-piece="N">♘</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase কনফিগারেশন (আপনার মূল অ্যাপের সাথে মিলিয়ে নিন)
        const firebaseConfig = {
            apiKey: "AIzaSyCS5nlNZ-SA5erCj0Cf1v5KWhfnmcfPmRw",
            authDomain: "high--call-message.firebaseapp.com",
            databaseURL: "https://high--call-message-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "high--call-message",
            storageBucket: "high--call-message.appspot.com",
            messagingSenderId: "369974545305",
            appId: "1:369974545305:web:10315a079922d1931fe108",
            measurementId: "G-3E4LTER2LF"
        };

        // Firebase ইনিশিয়ালাইজ
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // গেম ভেরিয়েবল
        let gameId;
        let playerId;
        let currentPlayer;
        let chessBoard = [];
        let selectedPiece = null;
        let possibleMoves = [];
        let gameRef;
        let chatRef;
        let isBoardFlipped = false;
        let playerTimer = 1800; // 30 minutes in seconds
        let opponentTimer = 1800;
        let playerTimerInterval;
        let opponentTimerInterval;
        let playerName = "আপনি";
        let opponentName = "প্রতিপক্ষ";
        let isGameStarted = false;
        let lastMove = null;
        let checkStatus = { white: false, black: false };
        let castlingRights = {
            white: { kingSide: true, queenSide: true },
            black: { kingSide: true, queenSide: true }
        };
        let enPassantTarget = null;
        let halfMoveClock = 0;
        let fullMoveNumber = 1;
        let gameStatus = 'ongoing';
        let rewardAmount = 0;
        let playerPhotoUrl = '';
        let opponentPhotoUrl = '';

        // URL থেকে গেম আইডি এবং প্লেয়ার আইডি পড়া
        const urlParams = new URLSearchParams(window.location.search);
        gameId = urlParams.get('gameId');
        playerId = parseInt(urlParams.get('playerId')) || 1;
        const entryFee = parseFloat(urlParams.get('entryFee')) || 0;

        // DOM এলিমেন্ট
        const gameArea = document.getElementById('game-area');
        const statusElement = document.getElementById('status');
        const chatButton = document.getElementById('chat-button');
        const chatContainer = document.getElementById('chat-container');
        const chatMessages = document.getElementById('chat-messages');
        const chatMessageInput = document.getElementById('chat-message');
        const chatSendBtn = document.getElementById('chat-send');
        const playerTimerElement = document.getElementById('player-timer');
        const opponentTimerElement = document.getElementById('opponent-timer');
        const playerNameDisplay = document.getElementById('player-name');
        const opponentNameDisplay = document.getElementById('opponent-name');
        const playerImage = document.getElementById('player-image');
        const opponentImage = document.getElementById('opponent-image');
        const rewardAmountElement = document.getElementById('reward-amount');

        // ইভেন্ট লিসেনার
        chatButton.addEventListener('click', toggleChat);
        chatSendBtn.addEventListener('click', sendMessage);
        chatMessageInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') sendMessage();
        });

        // গেম শুরু
        if (gameId) {
            initializeGame();
        } else {
            statusElement.textContent = 'গেম আইডি পাওয়া যায়নি!';
        }

        function initializeGame() {
            // Firebase থেকে ব্যবহারকারীর তথ্য লোড করুন
            const user = firebase.auth().currentUser;
            if (user) {
                database.ref('users/' + user.uid).once('value').then(snapshot => {
                    const userData = snapshot.val();
                    playerName = userData?.name || "আপনি";
                    playerPhotoUrl = userData?.photoURL || '';
                    updatePlayerInfo();
                });
            }

            gameRef = database.ref('games/' + gameId);
            chatRef = database.ref('chats/' + gameId);
            
            chessBoard = createInitialBoard();
            
            setupGameListeners();
            setupChatListeners();
            
            // UI আপডেট
            gameArea.style.display = 'block';
            
            // বোর্ড ফ্লিপ করা (প্লেয়ার 2 হলে)
            isBoardFlipped = playerId === 2;
            
            updateTimerDisplay();
            rewardAmountElement.textContent = entryFee * 2; // 2 জন খেলোয়াড়ের জন্য পুরস্কার
        }

        function updatePlayerInfo() {
            playerNameDisplay.textContent = playerName;
            if (playerPhotoUrl) {
                playerImage.innerHTML = `<img src="${playerPhotoUrl}" alt="Profile">`;
            }
        }

        function setupGameListeners() {
            gameRef.on('value', (snapshot) => {
                const gameData = snapshot.val();
                
                if (!gameData) {
                    statusElement.textContent = 'গেম পাওয়া যায়নি';
                    return;
                }

                if (gameData.status === 'started' || gameData.status === 'waiting') {
                    currentPlayer = gameData.currentPlayer || 1;
                    chessBoard = gameData.board || createInitialBoard();
                    
                    // প্লেয়ার তথ্য আপডেট
                    if (playerId === 1) {
                        playerTimer = gameData.player1?.timer || 1800;
                        opponentTimer = gameData.player2?.timer || 1800;
                        opponentName = gameData.player2?.name || "প্রতিপক্ষ";
                        opponentPhotoUrl = gameData.player2?.photoURL || '';
                    } else {
                        playerTimer = gameData.player2?.timer || 1800;
                        opponentTimer = gameData.player1?.timer || 1800;
                        opponentName = gameData.player1?.name || "প্রতিপক্ষ";
                        opponentPhotoUrl = gameData.player1?.photoURL || '';
                    }
                    
                    // রিওয়ার্ড আপডেট
                    rewardAmount = gameData.reward || entryFee * 2;
                    
                    lastMove = gameData.lastMove;
                    checkStatus = gameData.checkStatus || { white: false, black: false };
                    castlingRights = gameData.castlingRights || {
                        white: { kingSide: true, queenSide: true },
                        black: { kingSide: true, queenSide: true }
                    };
                    enPassantTarget = gameData.enPassantTarget;
                    halfMoveClock = gameData.halfMoveClock || 0;
                    fullMoveNumber = gameData.fullMoveNumber || 1;
                    gameStatus = gameData.gameStatus || 'ongoing';
                    
                    // UI আপডেট
                    opponentNameDisplay.textContent = opponentName;
                    if (opponentPhotoUrl) {
                        opponentImage.innerHTML = `<img src="${opponentPhotoUrl}" alt="Profile">`;
                    }
                    rewardAmountElement.textContent = rewardAmount;
                    
                    // Start timers when both players have joined
                    if (gameData.gameStarted && !isGameStarted) {
                        isGameStarted = true;
                        if (currentPlayer === playerId) {
                            startPlayerTimer();
                        } else {
                            startOpponentTimer();
                        }
                    }
                    
                    // Check for winner
                    if (playerTimer <= 0 || opponentTimer <= 0) {
                        endGame(playerTimer <= 0 ? (playerId === 1 ? 2 : 1) : (playerId === 1 ? 1 : 2));
                        return;
                    }
                    
                    renderBoard();
                    updateTimerDisplay();
                    updateStatus();
                }
            });
        }

        function setupChatListeners() {
            chatRef.on('child_added', (snapshot) => {
                const message = snapshot.val();
                addMessageToChat(message.sender, message.text, message.timestamp);
            });
        }

        function createInitialBoard() {
            return [
                ['r', 'n', 'b', 'q', 'k', 'b', 'n', 'r'],
                ['p', 'p', 'p', 'p', 'p', 'p', 'p', 'p'],
                ['', '', '', '', '', '', '', ''],
                ['', '', '', '', '', '', '', ''],
                ['', '', '', '', '', '', '', ''],
                ['', '', '', '', '', '', '', ''],
                ['P', 'P', 'P', 'P', 'P', 'P', 'P', 'P'],
                ['R', 'N', 'B', 'Q', 'K', 'B', 'N', 'R']
            ];
        }

        function renderBoard() {
            const boardElement = document.getElementById('board');
            boardElement.innerHTML = '';
            
            // সারিগুলোকে সঠিক ক্রমে রেন্ডার করুন (ফ্লিপ করা হলে)
            const rows = isBoardFlipped ? [7,6,5,4,3,2,1,0] : [0,1,2,3,4,5,6,7];
            const cols = isBoardFlipped ? [7,6,5,4,3,2,1,0] : [0,1,2,3,4,5,6,7];
            
            for (let i = 0; i < 8; i++) {
                const row = rows[i];
                for (let j = 0; j < 8; j++) {
                    const col = cols[j];
                    const square = document.createElement('div');
                    square.className = `square ${(row + col) % 2 === 0 ? 'light' : 'dark'}`;
                    square.dataset.row = row;
                    square.dataset.col = col;
                    
                    // শেষ চাল হাইলাইট
                    if (lastMove && (
                        (lastMove.from.row === row && lastMove.from.col === col) ||
                        (lastMove.to.row === row && lastMove.to.col === col)
                    )) {
                        square.classList.add('last-move');
                    }
                    
                    // চেক অবস্থা
                    const piece = chessBoard[row][col];
                    if (piece && piece.toLowerCase() === 'k') {
                        const color = piece === piece.toLowerCase() ? 'black' : 'white';
                        if (checkStatus[color]) {
                            square.classList.add('check');
                        }
                    }
                    
                    // গুটি সেট করা
                    if (piece) {
                        const color = piece === piece.toLowerCase() ? 'black' : 'white';
                        square.textContent = getPieceSymbol(piece);
                        square.classList.add(color);
                    }
                    
                    // নির্বাচিত পিস হাইলাইট
                    if (selectedPiece && selectedPiece.row === row && selectedPiece.col === col) {
                        square.classList.add('selected');
                    }
                    
                    // সম্ভাব্য মুভ মার্কার
                    const isPossibleMove = possibleMoves.some(move => 
                        move.to.row === row && move.to.col === col
                    );
                    
                    if (isPossibleMove) {
                        if (chessBoard[row][col]) {
                            square.classList.add('possible-capture');
                        } else {
                            square.classList.add('possible-move');
                        }
                    }
                    
                    square.addEventListener('click', () => handleSquareClick(row, col));
                    boardElement.appendChild(square);
                }
            }
        }

        function getPieceSymbol(piece) {
            const symbols = {
                'r': '♜', 'n': '♞', 'b': '♝', 'q': '♛', 'k': '♚', 'p': '♟',
                'R': '♖', 'N': '♘', 'B': '♗', 'Q': '♕', 'K': '♔', 'P': '♙'
            };
            return symbols[piece] || '';
        }

        function handleSquareClick(row, col) {
            if (gameStatus !== 'ongoing' || !isGameStarted) return;
            
            const piece = chessBoard[row][col];
            
            // যদি কোনো গুটি সিলেক্ট করা থাকে
            if (selectedPiece) {
                // একই স্কয়ার ক্লিক করলে সিলেকশন বাতিল
                if (selectedPiece.row === row && selectedPiece.col === col) {
                    selectedPiece = null;
                    possibleMoves = [];
                    renderBoard();
                    return;
                }
                
                // সম্ভাব্য মুভে ক্লিক করলে চাল দাও
                const isPossibleMove = possibleMoves.some(move => 
                    move.to.row === row && move.to.col === col
                );
                
                if (isPossibleMove) {
                    const move = possibleMoves.find(m => 
                        m.to.row === row && m.to.col === col
                    );
                    makeMove(move);
                    return;
                }
            }
            
            // নতুন গুটি সিলেক্ট করা
            if (piece && isOwnPiece(piece)) {
                selectedPiece = { row, col };
                possibleMoves = getPossibleMoves(row, col);
                renderBoard();
            }
        }

        function isOwnPiece(piece) {
            return (currentPlayer === 1 && piece === piece.toUpperCase()) ||
                   (currentPlayer === 2 && piece === piece.toLowerCase());
        }

        function getPossibleMoves(row, col) {
            const piece = chessBoard[row][col];
            const moves = [];
            
            if (!piece) return moves;
            
            const color = piece === piece.toLowerCase() ? 'black' : 'white';
            const pieceLower = piece.toLowerCase();
            
            switch (pieceLower) {
                case 'p': // সৈনিক
                    getPawnMoves(row, col, color, moves);
                    break;
                case 'r': // রথ
                    getRookMoves(row, col, color, moves);
                    break;
                case 'n': // ঘোড়া
                    getKnightMoves(row, col, color, moves);
                    break;
                case 'b': // উট
                    getBishopMoves(row, col, color, moves);
                    break;
                case 'q': // রাণী
                    getRookMoves(row, col, color, moves);
                    getBishopMoves(row, col, color, moves);
                    break;
                case 'k': // রাজা
                    getKingMoves(row, col, color, moves);
                    break;
            }
            
            // চেক এড়ানোর জন্য ফিল্টার
            return moves.filter(move => {
                // টেম্পরারি বোর্ডে চাল দিই
                const tempBoard = JSON.parse(JSON.stringify(chessBoard));
                const tempCastling = JSON.parse(JSON.stringify(castlingRights));
                const tempEnPassant = enPassantTarget;
                
                executeMove(move, tempBoard);
                
                // চেক আছে কিনা দেখি
                const kingPos = findKing(color, tempBoard);
                const isInCheck = isSquareUnderAttack(
                    kingPos.row, kingPos.col, 
                    color === 'white' ? 'black' : 'white', 
                    tempBoard
                );
                
                return !isInCheck;
            });
        }

        function getPawnMoves(row, col, color, moves) {
            const direction = color === 'white' ? -1 : 1;
            const startRow = color === 'white' ? 6 : 1;
            const enemyColor = color === 'white' ? 'black' : 'white';
            
            // সামনে এক ঘর
            if (isValidSquare(row + direction, col) && 
                chessBoard[row + direction][col] === '') {
                moves.push(createMove(row, col, row + direction, col));
                
                // প্রথমবার দুই ঘর
                if (row === startRow && 
                    chessBoard[row + 2*direction][col] === '') {
                    moves.push(createMove(row, col, row + 2*direction, col));
                }
            }
            
            // তির্যকভাবে খাওয়া
            const captureDirections = [[direction, -1], [direction, 1]];
            for (const [dr, dc] of captureDirections) {
                const newRow = row + dr;
                const newCol = col + dc;
                
                if (isValidSquare(newRow, newCol)) {
                    // সাধারণ ক্যাপচার
                    if (chessBoard[newRow][newCol] !== '' && 
                        isEnemyPiece(chessBoard[newRow][newCol], color)) {
                        moves.push(createMove(row, col, newRow, newCol));
                    }
                    
                    // এন পাসান্ট
                    if (enPassantTarget && 
                        enPassantTarget.row === newRow && 
                        enPassantTarget.col === newCol) {
                        moves.push({
                            from: { row, col },
                            to: { row: newRow, col: newCol },
                            enPassant: true
                        });
                    }
                }
            }
        }

        function getRookMoves(row, col, color, moves) {
            const directions = [[-1, 0], [1, 0], [0, -1], [0, 1]];
            getSlidingMoves(row, col, color, directions, moves);
        }

        function getKnightMoves(row, col, color, moves) {
            const knightMoves = [
                [-2, -1], [-2, 1], [-1, -2], [-1, 2],
                [1, -2], [1, 2], [2, -1], [2, 1]
            ];
            
            for (const [dr, dc] of knightMoves) {
                const newRow = row + dr;
                const newCol = col + dc;
                
                if (isValidSquare(newRow, newCol) && 
                    (chessBoard[newRow][newCol] === '' || 
                     isEnemyPiece(chessBoard[newRow][newCol], color))) {
                    moves.push(createMove(row, col, newRow, newCol));
                }
            }
        }

        function getBishopMoves(row, col, color, moves) {
            const directions = [[-1, -1], [-1, 1], [1, -1], [1, 1]];
            getSlidingMoves(row, col, color, directions, moves);
        }

        function getKingMoves(row, col, color, moves) {
            for (let dr = -1; dr <= 1; dr++) {
                for (let dc = -1; dc <= 1; dc++) {
                    if (dr === 0 && dc === 0) continue;
                    
                    const newRow = row + dr;
                    const newCol = col + dc;
                    
                    if (isValidSquare(newRow, newCol) && 
                        (chessBoard[newRow][newCol] === '' || 
                         isEnemyPiece(chessBoard[newRow][newCol], color))) {
                        moves.push(createMove(row, col, newRow, newCol));
                    }
                }
            }
            
            // কাস্টলিং
            getCastlingMoves(row, col, color, moves);
        }

        function getCastlingMoves(row, col, color, moves) {
            if (isSquareUnderAttack(row, col, color === 'white' ? 'black' : 'white', chessBoard)) {
                return; // চেক থাকলে কাস্টলিং করা যাবে না
            }
            
            const side = castlingRights[color];
            
            // কিং সাইড কাস্টলিং
            if (side.kingSide) {
                let canCastle = true;
                for (let c = col + 1; c < 7; c++) {
                    if (chessBoard[row][c] !== '') {
                        canCastle = false;
                        break;
                    }
                }
                
                // রাজা যে ঘরগুলো অতিক্রম করবে সেগুলোতে আক্রমণ আছে কিনা
                if (canCastle) {
                    for (let c = col; c <= col + 2; c++) {
                        if (isSquareUnderAttack(row, c, color === 'white' ? 'black' : 'white', chessBoard)) {
                            canCastle = false;
                            break;
                        }
                    }
                }
                
                if (canCastle) {
                    moves.push({
                        from: { row, col },
                        to: { row, col: col + 2 },
                        castling: 'kingSide'
                    });
                }
            }
            
            // কুইন সাইড কাস্টলিং
            if (side.queenSide) {
                let canCastle = true;
                for (let c = col - 1; c > 0; c--) {
                    if (chessBoard[row][c] !== '') {
                        canCastle = false;
                        break;
                    }
                }
                
                // রাজা যে ঘরগুলো অতিক্রম করবে সেগুলোতে আক্রমণ আছে কিনা
                if (canCastle) {
                    for (let c = col; c >= col - 2; c--) {
                        if (isSquareUnderAttack(row, c, color === 'white' ? 'black' : 'white', chessBoard)) {
                            canCastle = false;
                            break;
                        }
                    }
                }
                
                if (canCastle) {
                    moves.push({
                        from: { row, col },
                        to: { row, col: col - 2 },
                        castling: 'queenSide'
                    });
                }
            }
        }

        function getSlidingMoves(row, col, color, directions, moves) {
            for (const [dr, dc] of directions) {
                let newRow = row + dr;
                let newCol = col + dc;
                
                while (isValidSquare(newRow, newCol)) {
                    if (chessBoard[newRow][newCol] === '') {
                        moves.push(createMove(row, col, newRow, newCol));
                    } else {
                        if (isEnemyPiece(chessBoard[newRow][newCol], color)) {
                            moves.push(createMove(row, col, newRow, newCol));
                        }
                        break;
                    }
                    
                    newRow += dr;
                    newCol += dc;
                }
            }
        }

        function createMove(fromRow, fromCol, toRow, toCol, specialMove = null) {
            return {
                from: { row: fromRow, col: fromCol },
                to: { row: toRow, col: toCol },
                ...(specialMove && { [specialMove]: true })
            };
        }

        function isValidSquare(row, col) {
            return row >= 0 && row < 8 && col >= 0 && col < 8;
        }

        function isEnemyPiece(piece, color) {
            if (!piece) return false;
            return (color === 'white' && piece === piece.toLowerCase()) ||
                   (color === 'black' && piece === piece.toUpperCase());
        }

        function executeMove(move, board) {
            const { from, to } = move;
            const piece = board[from.row][from.col];
            const color = piece === piece.toLowerCase() ? 'black' : 'white';
            
            // এন পাসান্ট
            if (move.enPassant) {
                board[to.row][to.col] = piece;
                board[from.row][from.col] = '';
                board[from.row][to.col] = '';
            } 
            // কাস্টলিং
            else if (move.castling) {
                board[to.row][to.col] = piece;
                board[from.row][from.col] = '';
                
                // রথ সরানো
                if (move.castling === 'kingSide') {
                    board[to.row][7] = '';
                    board[to.row][to.col - 1] = color === 'white' ? 'R' : 'r';
                } else {
                    board[to.row][0] = '';
                    board[to.row][to.col + 1] = color === 'white' ? 'R' : 'r';
                }
            } 
            // সাধারণ চাল
            else {
                board[to.row][to.col] = piece;
                board[from.row][from.col] = '';
            }
            
            return board;
        }

        function makeMove(move) {
            const { from, to } = move;
            const piece = chessBoard[from.row][from.col];
            const color = piece === piece.toLowerCase() ? 'black' : 'white';
            
            // এন পাসান্ট
            if (move.enPassant) {
                chessBoard[to.row][to.col] = piece;
                chessBoard[from.row][from.col] = '';
                chessBoard[from.row][to.col] = '';
            } 
            // কাস্টলিং
            else if (move.castling) {
                chessBoard[to.row][to.col] = piece;
                chessBoard[from.row][from.col] = '';
                
                // রথ সরানো
                if (move.castling === 'kingSide') {
                    chessBoard[to.row][7] = '';
                    chessBoard[to.row][to.col - 1] = color === 'white' ? 'R' : 'r';
                } else {
                    chessBoard[to.row][0] = '';
                    chessBoard[to.row][to.col + 1] = color === 'white' ? 'R' : 'r';
                }
            } 
            // সাধারণ চাল
            else {
                chessBoard[to.row][to.col] = piece;
                chessBoard[from.row][from.col] = '';
                
                // প্রমোশন
                if (piece.toLowerCase() === 'p' && (to.row === 0 || to.row === 7)) {
                    showPromotionModal(to.row, to.col, color);
                    return;
                }
            }
            
            // এন পাসান্ট টার্গেট সেট করা
            enPassantTarget = null;
            if (piece.toLowerCase() === 'p' && Math.abs(from.row - to.row) === 2) {
                enPassantTarget = {
                    row: from.row + (to.row - from.row) / 2,
                    col: from.col
                };
            }
            
            // কাস্টলিং রাইটস আপডেট
            updateCastlingRights(from, piece);
            
            // হাফ মুভ ক্লক (50 মুভ রুল)
            if (piece.toLowerCase() === 'p' || chessBoard[to.row][to.col] !== '') {
                halfMoveClock = 0;
            } else {
                halfMoveClock++;
            }
            
            // কালো চাল দিলে ফুল মুভ সংখ্যা বাড়ানো
            if (currentPlayer === 2) {
                fullMoveNumber++;
            }
            
            // শেষ চাল সংরক্ষণ
            lastMove = move;
            
            // খেলোয়াড় পরিবর্তন
            currentPlayer = currentPlayer === 1 ? 2 : 1;
            
            // টাইমার আপডেট
            if (playerId === 1) {
                clearInterval(playerTimerInterval);
                startOpponentTimer();
            } else {
                clearInterval(opponentTimerInterval);
                startPlayerTimer();
            }
            
            // চেক অবস্থা আপডেট
            updateCheckStatus();
            
            // গেম স্ট্যাটাস চেক
            checkGameStatus();
            
            // ফায়ারবেজে আপডেট
            gameRef.update({
                board: chessBoard,
                currentPlayer: currentPlayer,
                lastMove: lastMove,
                checkStatus: checkStatus,
                castlingRights: castlingRights,
                enPassantTarget: enPassantTarget,
                halfMoveClock: halfMoveClock,
                fullMoveNumber: fullMoveNumber,
                gameStatus: gameStatus,
                [`player${playerId}/timer`]: playerTimer,
                [`player${playerId === 1 ? 2 : 1}/timer`]: opponentTimer,
                lastMoveTime: firebase.database.ServerValue.TIMESTAMP
            });
            
            // বোর্ড রিফ্রেশ
            selectedPiece = null;
            possibleMoves = [];
            renderBoard();
            updateStatus();
        }

        function showPromotionModal(row, col, color) {
            const modal = document.getElementById('promotion-modal');
            const options = document.querySelectorAll('.promotion-option');
            
            // কালো গুটির জন্য প্রতীক পরিবর্তন
            if (color === 'black') {
                options.forEach(option => {
                    option.textContent = option.dataset.piece.toLowerCase();
                    option.classList.remove('white');
                    option.classList.add('black');
                });
            } else {
                options.forEach(option => {
                    option.textContent = option.dataset.piece;
                    option.classList.remove('black');
                    option.classList.add('white');
                });
            }
            
            // ইভেন্ট লিসেনার
            const handlePromotion = (e) => {
                const selectedPiece = e.target.dataset.piece;
                const piece = color === 'white' ? selectedPiece : selectedPiece.toLowerCase();
                
                chessBoard[row][col] = piece;
                
                // মোডাল বন্ধ করা
                modal.style.display = 'none';
                options.forEach(option => {
                    option.removeEventListener('click', handlePromotion);
                });
                
                // খেলোয়াড় পরিবর্তন
                currentPlayer = currentPlayer === 1 ? 2 : 1;
                
                // টাইমার আপডেট
                if (playerId === 1) {
                    clearInterval(playerTimerInterval);
                    startOpponentTimer();
                } else {
                    clearInterval(opponentTimerInterval);
                    startPlayerTimer();
                }
                
                // চেক অবস্থা আপডেট
                updateCheckStatus();
                
                // গেম স্ট্যাটাস চেক
                checkGameStatus();
                
                // ফায়ারবেজে আপডেট
                gameRef.update({
                    board: chessBoard,
                    currentPlayer: currentPlayer,
                    checkStatus: checkStatus,
                    gameStatus: gameStatus,
                    [`player${playerId}/timer`]: playerTimer,
                    [`player${playerId === 1 ? 2 : 1}/timer`]: opponentTimer,
                    lastMoveTime: firebase.database.ServerValue.TIMESTAMP
                });
                
                // বোর্ড রিফ্রেশ
                selectedPiece = null;
                possibleMoves = [];
                renderBoard();
                updateStatus();
            };
            
            options.forEach(option => {
                option.addEventListener('click', handlePromotion);
            });
            
            modal.style.display = 'block';
        }

        function updateCastlingRights(from, piece) {
            const color = piece === piece.toLowerCase() ? 'black' : 'white';
            
            // রাজা নড়লে
            if (piece.toLowerCase() === 'k') {
                castlingRights[color].kingSide = false;
                castlingRights[color].queenSide = false;
            }
            
            // রথ নড়লে
            if (piece.toLowerCase() === 'r') {
                if (color === 'white') {
                    if (from.row === 7 && from.col === 0) {
                        castlingRights.white.queenSide = false;
                    } else if (from.row === 7 && from.col === 7) {
                        castlingRights.white.kingSide = false;
                    }
                } else {
                    if (from.row === 0 && from.col === 0) {
                        castlingRights.black.queenSide = false;
                    } else if (from.row === 0 && from.col === 7) {
                        castlingRights.black.kingSide = false;
                    }
                }
            }
        }

        function updateCheckStatus() {
            const whiteKingPos = findKing('white');
            const blackKingPos = findKing('black');
            
            checkStatus.white = isSquareUnderAttack(
                whiteKingPos.row, whiteKingPos.col, 'black', chessBoard
            );
            
            checkStatus.black = isSquareUnderAttack(
                blackKingPos.row, blackKingPos.col, 'white', chessBoard
            );
        }

        function findKing(color, board = chessBoard) {
            const king = color === 'white' ? 'K' : 'k';
            
            for (let row = 0; row < 8; row++) {
                for (let col = 0; col < 8; col++) {
                    if (board[row][col] === king) {
                        return { row, col };
                    }
                }
            }
            
            return null;
        }

        function isSquareUnderAttack(row, col, byColor, board) {
            // সব গুটি চেক করা
            for (let r = 0; r < 8; r++) {
                for (let c = 0; c < 8; c++) {
                    const piece = board[r][c];
                    
                    if (piece && isEnemyPiece(piece, byColor === 'white' ? 'black' : 'white')) {
                        const moves = getRawMoves(r, c, piece);
                        
                        if (moves.some(m => m.to.row === row && m.to.col === col)) {
                            return true;
                        }
                    }
                }
            }
            
            return false;
        }

        function getRawMoves(row, col, piece) {
            const moves = [];
            const color = piece === piece.toLowerCase() ? 'black' : 'white';
            const pieceLower = piece.toLowerCase();
            
            switch (pieceLower) {
                case 'p':
                    getPawnMoves(row, col, color, moves);
                    break;
                case 'r':
                    getRookMoves(row, col, color, moves);
                    break;
                case 'n':
                    getKnightMoves(row, col, color, moves);
                    break;
                case 'b':
                    getBishopMoves(row, col, color, moves);
                    break;
                case 'q':
                    getRookMoves(row, col, color, moves);
                    getBishopMoves(row, col, color, moves);
                    break;
                case 'k':
                    getKingMoves(row, col, color, moves);
                    break;
            }
            
            return moves;
        }

        function checkGameStatus() {
            // চেকমেট বা স্টেলমেট চেক
            const hasLegalMoves = hasLegalMovesForCurrentPlayer();
            const inCheck = checkStatus[currentPlayer === 1 ? 'white' : 'black'];
            
            if (!hasLegalMoves) {
                if (inCheck) {
                    gameStatus = currentPlayer === 1 ? 'blackWon' : 'whiteWon';
                } else {
                    gameStatus = 'stalemate';
                }
            }
            
            // 50 মুভ রুল
            if (halfMoveClock >= 50) {
                gameStatus = 'draw';
            }
            
            // ইনসাফিসিয়েন্ট মেটেরিয়াল
            if (isInsufficientMaterial()) {
                gameStatus = 'draw';
            }
        }

        function hasLegalMovesForCurrentPlayer() {
            for (let row = 0; row < 8; row++) {
                for (let col = 0; col < 8; col++) {
                    const piece = chessBoard[row][col];
                    
                    if (piece && isOwnPiece(piece)) {
                        const moves = getPossibleMoves(row, col);
                        
                        if (moves.length > 0) {
                            return true;
                        }
                    }
                }
            }
            
            return false;
        }

        function isInsufficientMaterial() {
            let whitePieces = [];
            let blackPieces = [];
            
            for (let row = 0; row < 8; row++) {
                for (let col = 0; col < 8; col++) {
                    const piece = chessBoard[row][col];
                    
                    if (piece) {
                        if (piece === piece.toUpperCase()) {
                            whitePieces.push(piece);
                        } else {
                            blackPieces.push(piece);
                        }
                    }
                }
            }
            
            // শুধু রাজা বনাম রাজা
            if (whitePieces.length === 1 && blackPieces.length === 1) {
                return true;
            }
            
            // রাজা + ঘোড়া বনাম রাজা
            if ((whitePieces.length === 2 && whitePieces.includes('N') && 
                 blackPieces.length === 1) ||
                (blackPieces.length === 2 && blackPieces.includes('n') && 
                 whitePieces.length === 1)) {
                return true;
            }
            
            // রাজা + উট বনাম রাজা
            if ((whitePieces.length === 2 && whitePieces.includes('B') && 
                 blackPieces.length === 1) ||
                (blackPieces.length === 2 && blackPieces.includes('b') && 
                 whitePieces.length === 1)) {
                return true;
            }
            
            return false;
        }

        function startPlayerTimer() {
            clearInterval(playerTimerInterval);
            playerTimerInterval = setInterval(() => {
                if (isGameStarted && currentPlayer === playerId) {
                    playerTimer--;
                    updateTimerDisplay();
                    
                    if (playerTimer <= 0) {
                        clearInterval(playerTimerInterval);
                        endGame(playerId === 1 ? 2 : 1);
                    }
                    
                    // Update timer in database
                    if (gameRef) {
                        gameRef.update({
                            [`player${playerId}/timer`]: playerTimer
                        });
                    }
                }
            }, 1000);
        }

        function startOpponentTimer() {
            clearInterval(opponentTimerInterval);
            opponentTimerInterval = setInterval(() => {
                if (isGameStarted && currentPlayer === (playerId === 1 ? 2 : 1)) {
                    opponentTimer--;
                    updateTimerDisplay();
                    
                    if (opponentTimer <= 0) {
                        clearInterval(opponentTimerInterval);
                        endGame(playerId === 1 ? 1 : 2);
                    }
                    
                    // Update timer in database
                    if (gameRef) {
                        gameRef.update({
                            [`player${playerId === 1 ? 2 : 1}/timer`]: opponentTimer
                        });
                    }
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const formatTime = (seconds) => {
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            };
            
            playerTimerElement.textContent = formatTime(playerTimer);
            opponentTimerElement.textContent = formatTime(opponentTimer);
        }

        function updateStatus() {
            switch (gameStatus) {
                case 'ongoing':
                    statusElement.textContent = `${currentPlayer === playerId ? 'আপনার' : 'প্রতিপক্ষের'} পালা`;
                    if (checkStatus[currentPlayer === 1 ? 'white' : 'black']) {
                        statusElement.textContent += ' (চেক!)';
                    }
                    break;
                case 'whiteWon':
                case 'blackWon':
                    statusElement.textContent = `${
                        gameStatus === 'whiteWon' ? 'সাদা' : 'কালো'
                    } চেকমেটে জিতেছে!`;
                    break;
                case 'stalemate':
                    statusElement.textContent = 'স্টেলমেট - ড্র!';
                    break;
                case 'draw':
                    statusElement.textContent = 'ড্র! (50 মুভ রুল বা অপর্যাপ্ত গুটি)';
                    break;
            }
        }

        function endGame(winnerId) {
            clearInterval(playerTimerInterval);
            clearInterval(opponentTimerInterval);
            isGameStarted = false;
            
            if (winnerId === playerId) {
                gameStatus = playerId === 1 ? 'whiteWon' : 'blackWon';
                statusElement.textContent = 'আপনি জিতেছেন!';
                statusElement.style.color = '#4CAF50';
                
                // জয়ী খেলোয়াড়কে পুরস্কার প্রদান
                if (firebase.auth().currentUser) {
                    const userId = firebase.auth().currentUser.uid;
                    database.ref('users/' + userId).update({
                        balance: firebase.database.ServerValue.increment(rewardAmount)
                    });
                }
            } else {
                gameStatus = playerId === 1 ? 'blackWon' : 'whiteWon';
                statusElement.textContent = 'আপনি হেরেছেন!';
                statusElement.style.color = '#F44336';
            }
            
            // ফায়ারবেজে আপডেট
            if (gameRef) {
                gameRef.update({
                    gameStatus: gameStatus,
                    winner: winnerId,
                    endTime: firebase.database.ServerValue.TIMESTAMP
                });
            }
            
            // চ্যাট ডিলিট করা
            if (chatRef) {
                chatRef.remove();
            }
            
            // 10 সেকেন্ড পর গেম ডাটা ডিলেট করুন
            setTimeout(() => {
                if (gameRef) gameRef.remove();
            }, 10000);
        }

        function toggleChat() {
            chatContainer.style.display = chatContainer.style.display === 'flex' ? 'none' : 'flex';
            if (chatContainer.style.display === 'flex') {
                chatMessageInput.focus();
            }
        }

        function sendMessage() {
            const messageText = chatMessageInput.value.trim();
            if (!messageText || !chatRef) return;
            
            const timestamp = new Date().getTime();
            chatRef.push({
                sender: playerId,
                text: messageText,
                timestamp: timestamp
            });
            
            chatMessageInput.value = '';
        }

        function addMessageToChat(senderId, text, timestamp) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${
                senderId === playerId ? 'own-message' : 'opponent-message'
            }`;
            
            const senderName = senderId === playerId ? playerName : opponentName;
            const time = new Date(timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            messageDiv.textContent = `${senderName}: ${text}`;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function exitGame() {
            if (confirm('আপনি কি নিশ্চিত গেম থেকে বের হতে চান?')) {
                // গেম থেকে বের হওয়ার লজিক
                if (gameRef) {
                    gameRef.update({
                        [`player${playerId}/left`]: true
                    });
                }
                
                // মূল অ্যাপে ফিরে যান
                window.location.href = 'TestRealmoneygame.html';
            }
        }
    </script>
</body>
</html>